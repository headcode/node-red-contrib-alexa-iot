<script type="text/javascript">
    RED.nodes.registerType('alexa-iot-device', {
        category: 'input',
        color: '#FF9900',
        defaults: {
            name: { value: '', required: true },
            hub: { value: '', required: true },
            targetNode: { value: '' },
            topic: { value: '' }
        },
        inputs: 1,
        outputs: 1,
        icon: 'light.png',
        label: function() {
            return this.name || 'Alexa IOT Device';
        },
        labelStyle: function() {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function() {
            const node = this;
            document.getElementById('node-input-name').setAttribute('aria-label', 'Device name for Alexa (required)');
            document.getElementById('node-input-hub').setAttribute('aria-label', 'Alexa IOT Hub ID (required)');
            document.getElementById('node-input-targetNode').setAttribute('aria-label', 'Target node ID (optional)');
            document.getElementById('node-input-topic').setAttribute('aria-label', 'Topic (optional)');

            // Auto-fill Hub ID if exactly one alexa-iot-hub exists
            let hubNodes = [];
            RED.nodes.eachNode(n => {
                if (n.type === 'alexa-iot-hub') {
                    hubNodes.push(n.id);
                }
            });
            const hubId = hubNodes.length === 1 ? hubNodes[0] : node.hub || '';
            document.getElementById('node-input-hub').value = hubId;
            document.getElementById('node-input-targetNode').value = node.targetNode || '';
            document.getElementById('node-input-topic').value = node.topic || '';
        },
        oneditsave: function() {
            const name = document.getElementById('node-input-name').value.trim();
            const hub = document.getElementById('node-input-hub').value.trim();
            const targetNode = document.getElementById('node-input-targetNode').value.trim();
            const topic = document.getElementById('node-input-topic').value.trim();

            if (!name) {
                RED.notify('Device name is required', 'error');
                throw new Error('Device name is required');
            }
            if (!hub || !RED.nodes.node(hub) || RED.nodes.node(hub).type !== 'alexa-iot-hub') {
                RED.notify('A valid Alexa IOT Hub ID is required', 'error');
                throw new Error('A valid Alexa IOT Hub ID is required');
            }
            if (targetNode && !RED.nodes.node(targetNode)) {
                RED.notify('Invalid target node ID', 'error');
                throw new Error('Invalid target node ID');
            }
            if (topic && !/^[a-z0-9_., ]+$/.test(topic)) {
                RED.notify('Topic must be lowercase alphanumeric, underscores, commas, or dots (e.g. light.living_room)', 'error');
                throw new Error('Invalid custom topic');
            }
            this.hub = hub;
            this.targetNode = targetNode;
            this.topic = topic;
        }
    });
</script>

<script type="text/html" data-template-name="alexa-iot-device">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Device Name" aria-label="Device name for Alexa">
    </div>
    <div class="form-row">
        <label for="node-input-hub"><i class="fa fa-server"></i> Hub ID</label>
        <input type="text" id="node-input-hub" placeholder="Alexa IOT Hub ID" aria-label="Alexa IOT Hub ID (required)">
    </div>
    <div class="form-row">
        <label for="node-input-targetNode"><i class="fa fa-share"></i> Target Node ID</label>
        <input type="text" id="node-input-targetNode" placeholder="Target node ID (optional)" aria-label="Target node ID (optional)">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-comment"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="Topic (optional)" aria-label="Topic (optional)">
    </div>
</script>

<script type="text/html" data-help-name="alexa-iot-device">
    <h3>Alexa IOT Device</h3>
    <p>This node receives commands (e.g. for power, brightness, or color) from an Alexa IOT Hub and forwards them to the output, and optionally, a user specified target node.</p>
    <h4>Configuration</h4>
    <ul>
        <li><strong>Name</strong>: The device name as it will appear in Alexa (e.g. Living Room Light). Required</li>
        <li><strong>Hub ID</strong>: The ID of the Alexa IOT Hub node to connect to. If one Hub exists in the project, this field is auto-filled with its ID. If zero or multiple hubs exist, it is left empty for the user to define. Required</li>
        <li><strong>Target Node ID</strong>: The ID of another node to forward messages to without wiring (optional). Messages still always present on the node output.</li>
        <li><strong>Topic</strong>: A custom topic for messages sent by this node (optional). If specified, it overrides the default topic (e.g. power, brightness, color). Must be lowercase alphanumeric, underscores, commas, or dots. Useful for Home Assistant entity IDs (e.g. light.hallway, cover.garage).</li>
    </ul>
    <h4>Finding a Node ID</h4>
    <p>To find the ID of a hub or target node:</p>
    <ol>
        <li><strong>Node Properties</strong>: Double-click a node in the editor. The ID is shown at the bottom of the configuration panel (e.g. "123abc45.678def"). Copy and paste it into the Hub ID or Target Node ID field.</li>
        <li><strong>Flow JSON</strong>: Click the menu (☰) > Export > Clipboard, select "all flows," and export. Open the JSON in a text editor and find the node’s <code>id</code> field (e.g. <code>"id": "123abc45.678def"</code>).</li>
    </ol>
    <p><strong>Note</strong>: The Hub ID must correspond to an Alexa IOT Hub node. The Target Node ID (if used) must correspond to a valid node.</p>
</script>

<style>
    .form-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        align-items: center;
        margin-bottom: 10px;
    }
    .form-row label {
        text-align: right;
        padding-right: 10px;
    }
    .form-row input[type="text"],
    .form-row select {
        width: 200px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
</style>
